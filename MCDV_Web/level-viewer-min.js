function clamp(e,t,r){return e<=t?t:e>=r?r:e}function degToRad(e){return e*Math.PI/180}function initGL(e){try{(gl=e.getContext("experimental-webgl")).viewportWidth=e.width,gl.viewportHeight=e.height}catch(e){}gl||alert("Could not initialise WebGL, sorry :-(")}function camera(){this.front=vec3.create([0,0,1]),this.up=vec3.create([0,1,0]),this.pos=vec3.create([-1.5,6.8,-11]),this.viewMatrix=mat4.create(),this.lastx=0,this.lasty=0,this.yaw=0,this.pitch=0,this.roll=0,this.sensitivity=.1,this.moveForward=function(e){var t=vec3.create();vec3.add(t,this.front),vec3.multiply(t,[e*deltaTime,e*deltaTime,e*deltaTime]),vec3.add(this.pos,t)},this.moveHorizontal=function(e){var t=vec3.create();vec3.cross(this.front,this.up,t),vec3.normalize(t),vec3.multiply(t,[e*deltaTime,e*deltaTime,e*deltaTime]),vec3.add(this.pos,t)},this.getMatrix=function(){mat4.identity(this.viewMatrix);var e=vec3.create();return vec3.add(e,this.pos),vec3.add(e,this.front),mat4.lookAt(this.pos,e,this.up,this.viewMatrix),this.viewMatrix},this.mouseUpdate=function(e,t){var r=e,i=t;this.lastx=e,this.lasty=t,r*=-this.sensitivity,i*=-this.sensitivity,this.pitch=clamp(this.pitch+i,-89,89),this.yaw+=r;var a=vec3.create();a[2]=Math.cos(degToRad(this.pitch))*Math.cos(degToRad(this.yaw)),a[1]=Math.sin(degToRad(this.pitch)),a[0]=Math.cos(degToRad(this.pitch))*Math.sin(degToRad(this.yaw)),this.front=a}}function getShader(e,t){var r=document.getElementById(t);if(!r)return null;for(var i="",a=r.firstChild;a;)3==a.nodeType&&(i+=a.textContent),a=a.nextSibling;var s;if("x-shader/x-fragment"==r.type)s=e.createShader(e.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=r.type)return null;s=e.createShader(e.VERTEX_SHADER)}return e.shaderSource(s,i),e.compileShader(s),e.getShaderParameter(s,e.COMPILE_STATUS)?s:(alert(e.getShaderInfoLog(s)),null)}function shader(e){var t=getShader(gl,e+"-fs"),r=getShader(gl,e+"-vs");this.program=gl.createProgram(),gl.attachShader(this.program,r),gl.attachShader(this.program,t),gl.linkProgram(this.program),gl.getProgramParameter(this.program,gl.LINK_STATUS)||alert("SHADER::INITIALIZE::FAIL SHADER("+e+")"),gl.enableVertexAttribArray(gl.getAttribLocation(this.program,"aVertexPosition")),gl.enableVertexAttribArray(gl.getAttribLocation(this.program,"aVertexNormal")),gl.enableVertexAttribArray(gl.getAttribLocation(this.program,"aTextureCoord")),this.setMatrix4fv=function(e,t){gl.uniformMatrix4fv(gl.getUniformLocation(this.program,e),!1,t)},this.setMatrix3fv=function(e,t){gl.uniformMatrix3fv(gl.getUniformLocation(this.program,e),!1,t)},this.setVector3f=function(e,t,r,i){gl.uniform3f(gl.getUniformLocation(this.program,e),t,r,i)},this.setVector3fv=function(e,t){gl.uniform3fv(gl.getUniformLocation(this.program,e),t)},this.setFloat=function(e,t){gl.uniform1f(gl.getUniformLocation(this.program,e),t)},this.setInt=function(e,t){gl.uniform1i(gl.getUniformLocation(this.program,e),t)},this.use=function(){gl.useProgram(this.program)}}function initShaders(){testShader=new shader("shader")}function handleLoadedTexture(e){gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0),gl.bindTexture(gl.TEXTURE_2D,e),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e.image),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR_MIPMAP_NEAREST),gl.generateMipmap(gl.TEXTURE_2D),gl.bindTexture(gl.TEXTURE_2D,null)}function initTexture(){(crateTexture=gl.createTexture()).image=new Image,crateTexture.image.onload=function(){handleLoadedTexture(crateTexture)},crateTexture.image.src="bsp.png",(modelTexture=gl.createTexture()).image=new Image,modelTexture.image.onload=function(){handleLoadedTexture(modelTexture)},modelTexture.image.src="model.png"}function mvPushMatrix(){var e=mat4.create();mat4.set(mvMatrix,e),mvMatrixStack.push(e)}function mvPopMatrix(){if(0==mvMatrixStack.length)throw"Invalid popMatrix!";mvMatrix=mvMatrixStack.pop()}function setMatrixUniforms(){return}function handleKeyDown(e){currentlyPressedKeys[e.keyCode]=!0}function handleKeyUp(e){currentlyPressedKeys[e.keyCode]=!1}function handleKeys(){currentlyPressedKeys[33]&&(z-=.05),currentlyPressedKeys[34]&&(z+=.05),currentlyPressedKeys[37]&&(ySpeed-=1),currentlyPressedKeys[39]&&(ySpeed+=1),currentlyPressedKeys[38]&&(xSpeed-=1),currentlyPressedKeys[40]&&(xSpeed+=1),currentlyPressedKeys[87]&&test_camera.moveForward(.5),currentlyPressedKeys[65]&&test_camera.moveHorizontal(-.5),currentlyPressedKeys[83]&&test_camera.moveForward(-.5),currentlyPressedKeys[68]&&test_camera.moveHorizontal(.5)}function handleMouseMove(e){1==e.which&&test_camera.mouseUpdate(e.movementX,e.movementY)}function handleClick(e){clicking=!0}function handleClickUp(e){clicking=!1}function gl_mesh(e,t,r,i){this.vertexPositionBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexPositionBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(e),gl.STATIC_DRAW),this.vertexPositionBuffer.itemSize=3,this.vertexPositionBuffer.numItems=e.length/3,this.normalBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.normalBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(t),gl.STATIC_DRAW),this.normalBuffer.itemSize=3,this.normalBuffer.numItems=t.length/3,this.texCoordBuffer=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this.texCoordBuffer),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(r),gl.STATIC_DRAW),this.texCoordBuffer.itemSize=2,this.texCoordBuffer.numItems=r.length/2,this.indicesBuffer=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indicesBuffer),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),gl.STATIC_DRAW),this.indicesBuffer.itemSize=1,this.indicesBuffer.numItems=i.length,console.log(this.vertexPositionBuffer),console.log(this.normalBuffer),this.draw=function(){gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexPositionBuffer),gl.vertexAttribPointer(0,this.vertexPositionBuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,this.normalBuffer),gl.vertexAttribPointer(1,this.normalBuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ARRAY_BUFFER,this.texCoordBuffer),gl.vertexAttribPointer(2,this.texCoordBuffer.itemSize,gl.FLOAT,!1,0,0),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indicesBuffer),gl.drawElements(gl.TRIANGLES,this.indicesBuffer.numItems,gl.UNSIGNED_SHORT,0)}}function initBuffers(){for(e=0;e<level.meshes.length;e++)level.meshes[e].indices.length>0&&all_meshes.push(new gl_mesh(level.meshes[e].positions,level.meshes[e].normals,level.meshes[e].uvCoords,level.meshes[e].indices));for(var e=0;e<level.cached_models.length;e++)level.cached_models[e].internal_mesh.indices.length>0&&cached_models.push(new gl_mesh(level.cached_models[e].internal_mesh.positions,level.cached_models[e].internal_mesh.normals,level.cached_models[e].internal_mesh.uvCoords,level.cached_models[e].internal_mesh.indices));return}function drawScene(){gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),mat4.perspective(50,gl.viewportWidth/gl.viewportHeight,.1,100,pMatrix),mat4.identity(mvMatrix),mat4.translate(mvMatrix,[0,0,0]),mat4.rotate(mvMatrix,degToRad(xRot),[1,0,0]),mat4.rotate(mvMatrix,degToRad(yRot),[0,1,0]),mat4.identity(viewMatrix),mat4.translate(viewMatrix,[0,-10,-30]),testShader.use(),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,crateTexture),testShader.setInt("uSampler",0),testShader.setVector3f("uAmbientColor",.3,.3,.3);var e=[-.5,-.4,-.7],t=vec3.create();vec3.normalize(e,t),vec3.scale(t,-1),testShader.setVector3fv("uLightingDirection",t),testShader.setVector3f("uDirectionalColor",1,1,1),testShader.setMatrix4fv("uPMatrix",pMatrix),testShader.setMatrix4fv("uMVMatrix",mvMatrix),testShader.setMatrix4fv("viewMatrix",test_camera.getMatrix());var r=mat3.create();mat4.toInverseMat3(mvMatrix,r),mat3.transpose(r),testShader.setMatrix3fv("uNMatrix",r);for(i=0;i<all_meshes.length;i++)all_meshes[i].draw();gl.bindTexture(gl.TEXTURE_2D,modelTexture);for(var i=0;i<level.models.length;i++)mat4.identity(mvMatrix),mat4.translate(mvMatrix,[.025*level.models[i].position[0],.025*level.models[i].position[2],-.025*level.models[i].position[1]]),mat4.rotate(mvMatrix,degToRad(level.models[i].rotation[0]),[0,0,1]),mat4.rotate(mvMatrix,degToRad(level.models[i].rotation[1]),[0,1,0]),mat4.rotate(mvMatrix,degToRad(level.models[i].rotation[2]),[1,0,0]),testShader.setMatrix4fv("uMVMatrix",mvMatrix),cached_models[level.models[i].modelID].draw()}function animate(){var e=(new Date).getTime();if(0!=lastTime){var t=e-lastTime;z+=t/1e3,deltaTime=.1*(e-lastTime),fps_time_counter+=t,frames+=1,fps_time_counter>1e3&&(fps_dom.innerHTML=frames+"fps",fps_time_counter=0,frames=0)}lastTime=e}function tick(){requestAnimFrame(tick),handleKeys(),drawScene(),animate()}function webGLStart(){var e=document.getElementById("glCanvas");e.width=window.innerWidth,e.height=window.innerHeight,fps_dom=document.getElementById("fps"),initGL(e),initShaders(),initBuffers(),initTexture(),gl.clearColor(.1,.1,.15,1),gl.enable(gl.DEPTH_TEST),document.onkeydown=handleKeyDown,document.onkeyup=handleKeyUp,document.onmousemove=handleMouseMove,document.onclick=handleClick,document.onclickup=handleClickUp,tick()}var gl,deltaTime=0,map_data=load_binary_resource("ar_baggage_raw.tbsp"),level=new tbsp_level(map_data),test_camera=new camera,tMatrix=test_camera.getMatrix(),shaderProgram,testShader,crateTexture,modelTexture,mvMatrix=mat4.create(),viewMatrix=mat4.create(),mvMatrixStack=[],pMatrix=mat4.create(),xRot=0,xSpeed=3,yRot=0,ySpeed=-3,z=-5,currentlyPressedKeys={},mouse_x=0,mouse_y=0,clicking=!1,test_mesh,test_mesh2,all_meshes=[],cached_models=[],z=0,viewMatrix=mat4.create(),lastTime=0,fps_time_counter=0;frames=0;var fps_dom;
